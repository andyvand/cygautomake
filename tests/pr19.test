#! /bin/sh

# Test associated with PR 19.
# From Matthew D. Langston.

. $srcdir/defs || exit 1

cat > configure.in << 'END'
AC_INIT(foo.l)
dnl Prevent automake from looking in .. and ../..
AC_CONFIG_AUX_DIR(.)
AM_INIT_AUTOMAKE(am_lex_bug, 0.1.1)

dnl Checks for programs.
AC_PROG_CC
AM_PROG_LEX
AC_PROG_YACC

AC_OUTPUT(Makefile)
END

cat > Makefile.am << 'END'
AUTOMAKE_OPTIONS  = foreign
LDADD             = @LEXLIB@

noinst_PROGRAMS   = foo
foo_SOURCES       = foo.l
END

# Remove some files installed by defs.  These will be reinstalled by
# automake.
rm -f install-sh missing mkinstalldirs depcomp

echo %% > foo.l

# Fail gracefully if no autoconf.
$needs_autoconf

# Likewise for gcc.
(gcc -v) > /dev/null 2>&1 || exit 77

# Likewise for gzip.
(gzip --version) > /dev/null 2>&1 || exit 77

$ACLOCAL || exit 1
$AUTOCONF || exit 1
$AUTOMAKE -a || exit 1
CC=gcc ./configure || exit 1
$MAKE || exit 1
$MAKE distcheck || exit 1

gunzip am_lex_bug-0.1.1.tar.gz || exit 1

tar tf am_lex_bug-0.1.1.tar | fgrep foo.c
